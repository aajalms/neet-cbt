<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NEET PG CBT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;font-family:Arial;background:#f4f6f8;overscroll-behavior:none;
}
header{
  background:#003366;color:#fff;padding:10px 20px;
  display:flex;justify-content:space-between;align-items:center;
}
.container{display:flex;height:calc(100vh - 56px);}
.main{width:70%;padding:20px;background:#fff;}
.palette{
  width:30%;padding:20px;background:#eef2f6;border-left:1px solid #ccc;
}
.question{font-size:18px;margin-bottom:15px;}
.options label{display:block;margin-bottom:8px;cursor:pointer;}
.controls button{padding:8px 14px;margin:8px 5px 0 0;font-weight:bold;}

.palette button{
  width:40px;height:40px;margin:4px;border:none;
  color:#fff;font-weight:bold;
}
.red{background:#e74c3c;}
.green{background:#27ae60;}
.yellow{background:#f1c40f;color:#000;}
.blue{background:#3498db;}
.current{outline:3px solid #000;}
.timer{font-weight:bold;}
</style>
</head>

<body>

<header>
  <div>NEET PG CBT</div>
  <div class="timer" id="timer">210:00</div>
  <div>Violations: <span id="vCount">0</span></div>
</header>

<div class="container">
  <div class="main">
    <div class="question" id="question"></div>
    <div class="options" id="options"></div>

    <div class="controls">
      <button onclick="prevQuestion()">Previous</button>
      <button onclick="nextQuestion()">Next</button>
      <button onclick="clearResponse()">Clear</button>
      <button onclick="markForReview()">Mark for Review</button>
      <button onclick="submitExam()">Submit</button>
    </div>
  </div>

  <div class="palette" id="palette"></div>
</div>

<script>
/* ================= AUTH ================= */
if(!sessionStorage.getItem("rollNo")) location.href="login.html";

/* ================= STATE ================= */
let violations=0;
let lock=false;
const MAX_VIOLATIONS=3;
const vCount=document.getElementById("vCount");

/* ================= FIREBASE ================= */
const FIREBASE_DB="https://YOUR_FIREBASE_DB.firebaseio.com";

function sendLive(status){
  fetch(⁠ ${FIREBASE_DB}/live/${sessionStorage.getItem("rollNo")}.json ⁠,{
    method:"PUT",
    body:JSON.stringify({
      rollNo:sessionStorage.getItem("rollNo"),
      status,
      time:new Date().toLocaleTimeString(),
      violations
    })
  }).catch(()=>{});
}

/* ================= QUESTIONS ================= */
const questions=[
  {q:"Pacemaker of heart is?",o:["AV node","SA node","Bundle of His","Purkinje fibers"],a:1},
  {q:"Most common nerve injured in humerus fracture?",o:["Ulnar","Radial","Median","Axillary"],a:1}
];

let current=0;
let answers=Array(questions.length).fill(null);
let reviewSet=new Set();

/* ================= TIMER ================= */
let timeLeft=210*60;
const timerEl=document.getElementById("timer");

const timer=setInterval(()=>{
  if(timeLeft<=0){
    clearInterval(timer);
    submitExam(true);
    return;
  }
  let m=Math.floor(timeLeft/60),s=timeLeft%60;
  timerEl.innerText=⁠ ${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")} ⁠;
  timeLeft--;
},1000);

/* ================= RENDER ================= */
function renderQuestion(){
  const q=questions[current];
  document.getElementById("question").innerText=
    ⁠ Question ${current+1}. ${q.q} ⁠;

  const opt=document.getElementById("options");
  opt.innerHTML="";
  q.o.forEach((o,i)=>{
    opt.innerHTML+=`
      <label>
        <input type="radio" name="opt"
        ${answers[current]===i?"checked":""}
        onclick="answers[${current}]=${i}">
        ${o}
      </label>`;
  });
  updatePalette();
}

function updatePalette(){
  const p=document.getElementById("palette");
  p.innerHTML="";
  questions.forEach((_,i)=>{
    const b=document.createElement("button");
    b.innerText=i+1;
    if(reviewSet.has(i)&&answers[i]!=null) b.className="blue";
    else if(reviewSet.has(i)) b.className="yellow";
    else if(answers[i]!=null) b.className="green";
    else b.className="red";
    if(i===current) b.classList.add("current");
    b.onclick=()=>{current=i;renderQuestion();};
    p.appendChild(b);
  });
}

/* ================= NAV ================= */
function nextQuestion(){if(current<questions.length-1){current++;renderQuestion();}}
function prevQuestion(){if(current>0){current--;renderQuestion();}}
function clearResponse(){answers[current]=null;renderQuestion();}
function markForReview(){
  reviewSet.has(current)?reviewSet.delete(current):reviewSet.add(current);
  renderQuestion();
}

/* ================= SUBMIT ================= */
function submitExam(auto=false){
  let score=0,correct=0,wrong=0,skipped=0;
  answers.forEach((a,i)=>{
    if(a===questions[i].a){score+=4;correct++}
    else if(a==null) skipped++;
    else{score--;wrong++}
  });

  sendLive(auto?"AUTO_SUBMITTED":"SUBMITTED");

  sessionStorage.setItem("neetResult",JSON.stringify({
    rollNo:sessionStorage.getItem("rollNo"),
    total:questions.length,
    correct,wrong,skipped,score,
    timeUsed:(210*60-timeLeft),
    violations,
    status:auto?"AUTO":"NORMAL"
  }));

  location.href="result.html";
}

/* ================= SECURITY ================= */
function recordViolation(reason){
  if(lock) return;
  lock=true;
  violations++;
  vCount.innerText=violations;
  sendLive("Violation: "+reason);

  if(violations>=MAX_VIOLATIONS){
    alert("❌ Auto submitted due to violations");
    submitExam(true);
  }else{
    alert(⁠ ⚠ ${reason} (${violations}/3) ⁠);
  }
  setTimeout(()=>lock=false,1500);
}

/* Desktop fullscreen only */
setTimeout(()=>{
  try{
    if(!/iphone|ipad|android/i.test(navigator.userAgent))
      document.documentElement.requestFullscreen();
  }catch(e){}
},1000);

document.addEventListener("fullscreenchange",()=>{
  if(!document.fullscreenElement)
    recordViolation("Exited fullscreen");
});
document.addEventListener("visibilitychange",()=>{
  if(document.hidden) recordViolation("Tab switch");
});
document.addEventListener("contextmenu",e=>{
  e.preventDefault();recordViolation("Right click");
});
document.addEventListener("keydown",e=>{
  if(e.key==="F12"||e.key==="F5"||(e.ctrlKey&&["r","u","s"].includes(e.key))){
    e.preventDefault();recordViolation("Restricted key");
  }
});

/* INIT */
sendLive("Exam Started");
renderQuestion();
</script>

</body>
</html>